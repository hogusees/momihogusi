<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ブログ管理 - ほぐし処 HoguSeeS</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: #f5f5f5;
            line-height: 1.6;
        }

        .header {
            background: #8B4513;
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
        }

        .header-nav {
            display: flex;
            gap: 1rem;
        }

        .header-nav a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .header-nav a:hover {
            background: rgba(255,255,255,0.2);
        }

        .main-content {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .section {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.3rem;
            color: #333;
            margin-bottom: 1rem;
            border-bottom: 2px solid #8B4513;
            padding-bottom: 0.5rem;
        }

        .blog-form {
            display: grid;
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 0.8rem;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #8B4513;
        }

        .form-group textarea {
            min-height: 200px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1rem;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: background 0.3s;
            font-size: 1rem;
        }

        .btn-primary {
            background: #8B4513;
            color: white;
        }

        .btn-primary:hover {
            background: #A0522D;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .seo-tips {
            background: #e8f5e8;
            border: 1px solid #b8daff;
            border-radius: 5px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .seo-tips h4 {
            color: #004085;
            margin-bottom: 0.5rem;
        }

        .keyword-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .keyword-tag {
            background: #8B4513;
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.3s;
        }

        .keyword-tag:hover {
            background: #A0522D;
        }

        .posts-list {
            display: grid;
            gap: 1rem;
        }

        .post-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            max-width: 100%;
            overflow: hidden;
        }

        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
            gap: 1rem;
        }

        .post-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 0.3rem;
            word-break: break-word;
            min-width: 0;
        }

        .post-meta {
            color: #666;
            font-size: 0.9rem;
            word-break: break-word;
            min-width: 0;
        }

        .post-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .btn-sm {
            padding: 0.3rem 0.6rem;
            font-size: 0.75rem;
            white-space: nowrap;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .character-count {
            font-size: 0.8rem;
            color: #666;
            text-align: right;
            margin-top: 0.3rem;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .header-nav {
                flex-wrap: wrap;
            }

            .form-actions {
                flex-direction: column;
            }

            .post-header {
                flex-direction: column;
                gap: 0.5rem;
            }

            .post-actions {
                justify-content: flex-start;
            }
        }

        @media (min-width: 769px) {
            .post-header {
                align-items: center;
            }
            
            .post-actions {
                margin-left: auto;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1>ブログ管理 - ほぐし処 HoguSeeS</h1>
            <nav class="header-nav">
                <a href="index.html"><i class="fas fa-tachometer-alt"></i> ダッシュボード</a>
                <a href="blog.html"><i class="fas fa-edit"></i> ブログ管理</a>
                <a href="../index.html" target="_blank"><i class="fas fa-external-link-alt"></i> サイト確認</a>
                <a href="#" onclick="checkMicroCMSSchema()"><i class="fas fa-database"></i> スキーマ確認</a>
                <a href="#" onclick="debugStorage()"><i class="fas fa-bug"></i> デバッグ</a>
                <span class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ログアウト</span>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <!-- 新規投稿フォーム -->
        <div class="section">
            <h2 class="section-title">新規ブログ投稿</h2>
            
            <!-- SEO推奨事項 -->
            <div class="seo-tips">
                <h4><i class="fas fa-lightbulb"></i> SEO推奨キーワード</h4>
                <p>今週のトレンドキーワードをタイトルや本文に含めることで検索されやすくなります。</p>
                <div class="keyword-suggestions" id="keywordSuggestions">
                    <!-- JavaScriptで動的生成 -->
                </div>
            </div>
            
            <form class="blog-form" onsubmit="savePost(event)">
                <div class="form-group">
                    <label for="postTitle">タイトル *</label>
                    <input type="text" id="postTitle" required placeholder="例: デスクワークの肩こりを解消する3つの方法">
                    <div class="character-count">
                        <span id="titleCount">0</span>/60文字（SEO推奨: 30-60文字）
                    </div>
                </div>

                <div class="form-group">
                    <label for="postContent">本文 *</label>
                    <textarea id="postContent" required placeholder="記事の内容を書いてください..."></textarea>
                    <div class="character-count">
                        <span id="contentCount">0</span>文字
                    </div>
                </div>

                <div class="form-group">
                    <label for="postSummary">概要</label>
                    <textarea id="postSummary" placeholder="記事の要約を書いてください（検索結果に表示されます）"></textarea>
                    <div class="character-count">
                        <span id="summaryCount">0</span>/160文字（SEO推奨: 120-160文字）
                    </div>
                </div>

                <div class="form-group">
                    <label for="postCategory">カテゴリ</label>
                    <select id="postCategory">
                        <option value="massage">マッサージ技術</option>
                        <option value="health">健康情報</option>
                        <option value="selfcare">セルフケア</option>
                        <option value="store">店舗情報</option>
                        <option value="staff">スタッフブログ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="postTags">タグ（カンマ区切り）</label>
                    <input type="text" id="postTags" placeholder="肩こり, デスクワーク, 武豊町">
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="saveDraft()">
                        <i class="fas fa-save"></i> 下書き保存
                    </button>
                    <button type="button" class="btn btn-outline" onclick="cancelEdit()" id="cancelEditBtn" style="display: none;">
                        <i class="fas fa-times"></i> 編集キャンセル
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> 投稿する
                    </button>
                </div>
            </form>
        </div>

        <!-- 既存の投稿一覧 -->
        <div class="section">
            <h2 class="section-title">投稿済み記事</h2>
            <div class="posts-list" id="postsList">
                <!-- JavaScriptで動的生成 -->
            </div>
        </div>
    </main>

    <script>
        // 認証チェック
        function checkAuth() {
            const adminAuth = localStorage.getItem('adminAuth');
            if (adminAuth !== 'true') {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        // microCMSのスキーマを確認
        async function checkMicroCMSSchema() {
            try {
                const response = await fetch('https://hogusees-blog.microcms.io/api/v1/blogs', {
                    method: 'GET',
                    headers: {
                        'X-API-KEY': 'vdklHLdPlKkoI0O5I68A8qDeRTSJnDyazTWn',
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`スキーマ確認に失敗しました: ${response.status}`);
                }

                const data = await response.json();
                console.log('microCMSスキーマ情報:', data);
                
                // 最初の記事があれば、そのフィールド構造を確認
                if (data.contents && data.contents.length > 0) {
                    const firstPost = data.contents[0];
                    console.log('既存記事のフィールド構造:', Object.keys(firstPost));
                    alert(`microCMSのスキーマ確認完了。\n利用可能なフィールド: ${Object.keys(firstPost).join(', ')}`);
                } else {
                    alert('microCMSに記事がありません。新規投稿でスキーマを確認してください。');
                }

            } catch (error) {
                console.error('スキーマ確認エラー:', error);
                alert(`スキーマ確認に失敗しました: ${error.message}`);
            }
        }

        // ログアウト
        function logout() {
            localStorage.removeItem('adminAuth');
            localStorage.removeItem('loginTime');
            window.location.href = 'login.html';
        }

        // 文字数カウント
        function setupCharacterCount() {
            const titleInput = document.getElementById('postTitle');
            const summaryInput = document.getElementById('postSummary');
            const contentInput = document.getElementById('postContent');

            titleInput.addEventListener('input', () => {
                document.getElementById('titleCount').textContent = titleInput.value.length;
            });

            summaryInput.addEventListener('input', () => {
                document.getElementById('summaryCount').textContent = summaryInput.value.length;
            });

            contentInput.addEventListener('input', () => {
                document.getElementById('contentCount').textContent = contentInput.value.length;
            });
        }

        // SEOキーワード提案の読み込み
        function loadKeywordSuggestions() {
            const keywords = [
                '武豊町 マッサージ',
                '肩こり 解消',
                'デスクワーク 疲れ',
                '腰痛 改善',
                'リラクゼーション',
                '知多半島',
                'セルフケア',
                'ストレス解消',
                '冷え性 改善',
                '美浜町 常滑市'
            ];

            const container = document.getElementById('keywordSuggestions');
            container.innerHTML = keywords.map(keyword => 
                `<span class="keyword-tag" onclick="insertKeyword('${keyword}')">${keyword}</span>`
            ).join('');
        }

        // キーワードをタイトルに挿入
        function insertKeyword(keyword) {
            const titleInput = document.getElementById('postTitle');
            const currentValue = titleInput.value;
            
            if (!currentValue.includes(keyword)) {
                titleInput.value = currentValue ? `${currentValue} ${keyword}` : keyword;
                titleInput.dispatchEvent(new Event('input'));
            }
        }

        // ブログ投稿の保存
        async function savePost(event) {
            event.preventDefault();
            
            const title = document.getElementById('postTitle').value;
            const summary = document.getElementById('postSummary').value;
            const content = document.getElementById('postContent').value;
            const category = document.getElementById('postCategory').value;
            // tagsフィールドを一時的にコメントアウト
            // const tags = document.getElementById('postTags').value.split(',').map(tag => tag.trim());

            if (!title || !content) {
                alert('タイトルと本文は必須です。');
                return;
            }

            const createdAt = new Date().toISOString();

            // microCMSに直接投稿
            try {
                const postData = {
                    title: title,
                    content: content,
                    category: category,
                    // tags: tags, // スキーマに存在しないため一時的に削除
                    publishedAt: createdAt
                };

                // スキーマに存在するフィールドのみを送信
                // summaryフィールドはスキーマに存在しないため削除

                const response = await fetch('https://hogusees-blog.microcms.io/api/v1/blogs', {
                    method: 'POST',
                    headers: {
                        'X-API-KEY': 'vdklHLdPlKkoI0O5I68A8qDeRTSJnDyazTWn',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(postData)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('microCMS API エラー詳細:', {
                        status: response.status,
                        statusText: response.statusText,
                        responseText: errorText
                    });
                    throw new Error(`投稿に失敗しました: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                console.log('microCMS投稿成功:', result);

                // 成功時の処理
                document.querySelector('.blog-form').reset();
                
                // 文字数カウンターもリセット
                document.getElementById('titleCount').textContent = '0';
                document.getElementById('summaryCount').textContent = '0';
                document.getElementById('contentCount').textContent = '0';

                // 投稿一覧を更新
                loadPostsList();

                // 成功メッセージ
                alert('ブログ記事がmicroCMSに投稿されました！LPの最新情報にも反映されます。');
                
                // LPの最新情報を更新
                try {
                    localStorage.setItem('blogUpdated', Date.now().toString());
                    
                    if (typeof BroadcastChannel !== 'undefined') {
                        const channel = new BroadcastChannel('hogusees_updates');
                        channel.postMessage({ type: 'blog_updated' });
                    }
                } catch (e) {
                    console.log('LPの自動更新処理でエラー:', e);
                }

            } catch (error) {
                console.error('microCMS投稿エラー:', error);
                
                // エラー時はlocalStorageにバックアップ保存
                const postData = {
                    id: 'temp_' + Date.now(),
                    title: title,
                    summary: summary,
                    content: content,
                    category: category,
                    // tags: tags, // スキーマに存在しないため一時的に削除
                    status: 'published',
                    createdAt: createdAt,
                    author: 'ほぐし処スタッフ'
                };

                const posts = JSON.parse(localStorage.getItem('blogPosts') || '[]');
                posts.unshift(postData);
                localStorage.setItem('blogPosts', JSON.stringify(posts));

                alert(`microCMSへの投稿に失敗しました。ローカルにバックアップ保存しました。\nエラー: ${error.message}`);
                
                // 投稿一覧を更新
                loadPostsList();
            }
        }

        // 下書き保存
        function saveDraft() {
            const draftData = {
                id: 'draft_' + Date.now(),
                title: document.getElementById('postTitle').value,
                summary: document.getElementById('postSummary').value,
                content: document.getElementById('postContent').value,
                category: document.getElementById('postCategory').value,
                // tags: document.getElementById('postTags').value.split(',').map(tag => tag.trim()), // スキーマに存在しないため一時的に削除
                status: 'draft',
                createdAt: new Date().toISOString(),
                author: 'ほぐし処スタッフ'
            };

            const drafts = JSON.parse(localStorage.getItem('blogDrafts') || '[]');
            drafts.unshift(draftData);
            localStorage.setItem('blogDrafts', JSON.stringify(drafts));

            alert('下書きが保存されました！');
        }

        // 投稿一覧の読み込み
        async function loadPostsList() {
            try {
                // microCMSから投稿を取得
                const response = await fetch('https://hogusees-blog.microcms.io/api/v1/blogs?limit=100', {
                    headers: {
                        'X-API-KEY': 'vdklHLdPlKkoI0O5I68A8qDeRTSJnDyazTWn',
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`投稿の取得に失敗しました: ${response.status}`);
                }

                const data = await response.json();
                const posts = data.contents || [];

                // ローカルストレージの下書きも取得
                const drafts = JSON.parse(localStorage.getItem('blogDrafts') || '[]');
                const deletedPostIds = JSON.parse(localStorage.getItem('deletedPostIds') || '[]');
                
                // 削除された記事を除外
                const filteredPosts = posts.filter(post => !deletedPostIds.includes(post.id));
                const filteredDrafts = drafts.filter(draft => !deletedPostIds.includes(draft.id));
                
                const allPosts = [...filteredPosts, ...filteredDrafts].sort((a, b) => new Date(b.publishedAt || b.createdAt) - new Date(a.publishedAt || a.createdAt));

                const container = document.getElementById('postsList');
                
                if (allPosts.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666;">まだ記事がありません。最初の記事を投稿してみましょう！</p>';
                    return;
                }

                container.innerHTML = allPosts.map(post => `
                    <div class="post-item">
                        <div class="post-header">
                            <div>
                                <div class="post-title">${post.title}</div>
                                <div class="post-meta">
                                    ${new Date(post.publishedAt || post.createdAt).toLocaleDateString('ja-JP')} | 
                                    ${post.id.startsWith('temp_') ? '下書き' : '公開中'} | 
                                    ${post.category || '未分類'}
                                </div>
                            </div>
                            <div class="post-actions">
                                <button class="btn btn-sm btn-secondary" onclick="editPost('${post.id}')">
                                    <i class="fas fa-edit"></i> 編集
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deletePost('${post.id}')">
                                    <i class="fas fa-trash"></i> 削除
                                </button>
                            </div>
                        </div>
                        <div class="post-summary">${post.summary || post.content.substring(0, 100)}...</div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('投稿取得エラー:', error);
                
                // エラー時はlocalStorageから取得
                const posts = JSON.parse(localStorage.getItem('blogPosts') || '[]');
                const drafts = JSON.parse(localStorage.getItem('blogDrafts') || '[]');
                const deletedPostIds = JSON.parse(localStorage.getItem('deletedPostIds') || '[]');
                
                // 削除された記事を除外
                const filteredPosts = posts.filter(post => !deletedPostIds.includes(post.id));
                const filteredDrafts = drafts.filter(draft => !deletedPostIds.includes(draft.id));
                
                const allPosts = [...filteredPosts, ...filteredDrafts].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                const container = document.getElementById('postsList');
                
                if (allPosts.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666;">投稿の取得に失敗しました。しばらく時間をおいてから再度お試しください。</p>';
                    return;
                }

                container.innerHTML = allPosts.map(post => `
                    <div class="post-item">
                        <div class="post-header">
                            <div>
                                <div class="post-title">${post.title}</div>
                                <div class="post-meta">
                                    ${new Date(post.createdAt).toLocaleDateString('ja-JP')} | 
                                    ${post.status === 'published' ? '公開中' : '下書き'} | 
                                    ${post.category} | ID: ${post.id}
                                </div>
                            </div>
                            <div class="post-actions">
                                <button class="btn btn-sm btn-secondary" onclick="editPost('${post.id}')">
                                    <i class="fas fa-edit"></i> 編集
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deletePost('${post.id}')">
                                    <i class="fas fa-trash"></i> 削除
                                </button>
                            </div>
                        </div>
                        <div class="post-summary">${post.summary || post.content.substring(0, 100)}...</div>
                    </div>
                `).join('');
            }
        }

        // 編集キャンセル
        function cancelEdit() {
            const form = document.querySelector('.blog-form');
            
            // フォームをリセット
            form.reset();
            form.removeAttribute('data-edit-mode');
            form.removeAttribute('data-edit-id');

            // ボタンを元に戻す
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> 投稿する';
            submitBtn.onclick = savePost;

            // キャンセルボタンを非表示
            document.getElementById('cancelEditBtn').style.display = 'none';

            // 文字数カウンターをリセット
            document.getElementById('titleCount').textContent = '0';
            document.getElementById('summaryCount').textContent = '0';
            document.getElementById('contentCount').textContent = '0';

            alert('編集をキャンセルしました。新規投稿モードに戻りました。');
        }

        // 記事更新（新規投稿として再作成）
        async function updatePost(event) {
            event.preventDefault();
            
            const form = document.querySelector('.blog-form');
            const editId = form.getAttribute('data-edit-id');
            
            if (!editId) {
                alert('編集モードではありません。');
                return;
            }

            const title = document.getElementById('postTitle').value;
            const summary = document.getElementById('postSummary').value;
            const content = document.getElementById('postContent').value;
            const category = document.getElementById('postCategory').value;

            if (!title || !content) {
                alert('タイトルと本文は必須です。');
                return;
            }

            try {
                // 更新データのログ出力（スキーマに存在するフィールドのみ）
                const updateData = {
                    title: title,
                    content: content,
                    category: category,
                    publishedAt: new Date().toISOString()
                };
                console.log('更新データ:', updateData);
                console.log('更新対象記事ID:', editId);

                // 修正した内容で新規投稿を作成
                console.log('新規投稿を作成中...');
                const createResponse = await fetch('https://hogusees-blog.microcms.io/api/v1/blogs', {
                    method: 'POST',
                    headers: {
                        'X-API-KEY': 'vdklHLdPlKkoI0O5I68A8qDeRTSJnDyazTWn',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                if (!createResponse.ok) {
                    const errorText = await createResponse.text();
                    console.error('新規投稿エラー詳細:', createResponse.status, errorText);
                    
                    if (createResponse.status === 400) {
                        // スキーマエラーの詳細を解析
                        try {
                            const errorData = JSON.parse(errorText);
                            if (errorData.message && errorData.message.includes('unexpected key')) {
                                throw new Error(`新規投稿に失敗しました: スキーマに存在しないフィールドが含まれています。\n詳細: ${errorData.message}`);
                            }
                        } catch (e) {
                            // JSON解析に失敗した場合は通常のエラーメッセージ
                        }
                        throw new Error(`新規投稿に失敗しました: リクエストの形式が正しくありません。\n詳細: ${errorText}`);
                    } else if (createResponse.status === 403) {
                        throw new Error(`新規投稿に失敗しました: 権限がありません。APIキーを確認してください。`);
                    } else {
                        throw new Error(`新規投稿に失敗しました: ${createResponse.status} - ${errorText}`);
                    }
                }

                // 新規投稿成功のログ出力
                const result = await createResponse.json();
                console.log('新規投稿成功:', result);

                // 新規投稿が成功したら、既存記事を削除
                console.log('既存記事を削除中...');
                const deleteResponse = await fetch(`https://hogusees-blog.microcms.io/api/v1/blogs/${editId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-API-KEY': 'vdklHLdPlKkoI0O5I68A8qDeRTSJnDyazTWn',
                        'Content-Type': 'application/json'
                    }
                });

                if (!deleteResponse.ok) {
                    console.error('既存記事の削除に失敗:', deleteResponse.status);
                    // 削除に失敗しても新規投稿は成功しているので警告のみ
                    console.warn('既存記事の削除に失敗しましたが、新規投稿は成功しています。');
                } else {
                    console.log('既存記事の削除完了');
                }

                // フォームをリセット
                form.reset();
                form.removeAttribute('data-edit-mode');
                form.removeAttribute('data-edit-id');

                // ボタンを元に戻す
                const submitBtn = form.querySelector('button[type="submit"]');
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> 投稿する';
                submitBtn.onclick = savePost;

                // キャンセルボタンを非表示
                document.getElementById('cancelEditBtn').style.display = 'none';

                // 文字数カウンターをリセット
                document.getElementById('titleCount').textContent = '0';
                document.getElementById('summaryCount').textContent = '0';
                document.getElementById('contentCount').textContent = '0';

                // 投稿一覧を更新
                loadPostsList();

                alert('記事が正常に更新されました！（既存記事を削除して新規投稿として再作成しました）');

            } catch (error) {
                console.error('更新エラー:', error);
                alert(`記事の更新に失敗しました: ${error.message}`);
            }
        }

        // 記事編集
        async function editPost(postId) {
            try {
                let post;
                
                // microCMSの記事かローカルの記事かを判定
                if (!postId.startsWith('temp_')) {
                    // microCMSの記事を取得
                    const response = await fetch(`https://hogusees-blog.microcms.io/api/v1/blogs/${postId}`, {
                        headers: {
                            'X-API-KEY': 'vdklHLdPlKkoI0O5I68A8qDeRTSJnDyazTWn',
                            'Content-Type': 'application/json'
                    }
                    });

                    if (!response.ok) {
                        throw new Error(`記事の取得に失敗しました: ${response.status}`);
                    }

                    post = await response.json();
                } else {
                    // ローカルの下書き記事
                    const drafts = JSON.parse(localStorage.getItem('blogDrafts') || '[]');
                    post = drafts.find(p => p.id === postId);
                }

                if (post) {
                    // フォームに記事データを設定
                    document.getElementById('postTitle').value = post.title;
                    document.getElementById('postSummary').value = post.summary || '';
                    document.getElementById('postContent').value = post.content;
                    document.getElementById('postCategory').value = post.category || 'massage';

                    // 文字数カウンターを更新
                    document.getElementById('titleCount').textContent = post.title.length;
                    document.getElementById('summaryCount').textContent = (post.summary || '').length;
                    document.getElementById('contentCount').textContent = post.content.length;

                    // 編集モードの設定
                    const form = document.querySelector('.blog-form');
                    form.setAttribute('data-edit-mode', 'true');
                    form.setAttribute('data-edit-id', postId);

                    // ボタンのテキストを変更
                    const submitBtn = form.querySelector('button[type="submit"]');
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> 更新して再投稿';
                    submitBtn.onclick = updatePost;

                    // キャンセルボタンを表示
                    document.getElementById('cancelEditBtn').style.display = 'inline-block';

                    // フォームを上部にスクロール
                    form.scrollIntoView({ behavior: 'smooth' });

                    alert('記事を編集モードで読み込みました。修正後に「更新する」ボタンを押してください。');
                } else {
                    alert('記事が見つかりませんでした。');
                }

            } catch (error) {
                console.error('記事編集エラー:', error);
                alert(`記事の編集に失敗しました: ${error.message}`);
            }
        }

        // 記事削除
        async function deletePost(postId, showConfirm = true) {
            if (showConfirm && !confirm('この記事を削除しますか？\n\n削除すると元に戻すことはできません。')) {
                return;
            }

            // 記事IDの検証
            if (!postId || postId === '') {
                alert('記事IDが無効です。');
                return;
            }

            try {
                // microCMSから削除（一時的な投稿でない場合）
                if (!postId.startsWith('temp_')) {
                    console.log('microCMSから記事を削除中:', postId);
                    console.log('削除対象の記事ID:', postId);
                    console.log('削除APIエンドポイント:', `https://hogusees-blog.microcms.io/api/v1/blogs/${postId}`);
                    
                    try {
                        const response = await fetch(`https://hogusees-blog.microcms.io/api/v1/blogs/${postId}`, {
                            method: 'DELETE',
                            headers: {
                                'X-API-KEY': 'vdklHLdPlKkoI0O5I68A8qDeRTSJnDyazTWn',
                                'Content-Type': 'application/json'
                            }
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('削除エラー詳細:', response.status, errorText);
                            
                            if (response.status === 400) {
                                // 400エラーの場合は、記事IDの形式を確認
                                console.warn('400エラーが発生。記事IDの形式を確認:', postId);
                                console.warn('記事IDの長さ:', postId.length);
                                console.warn('記事IDの文字種:', /^[a-zA-Z0-9_-]+$/.test(postId) ? '有効' : '無効');
                                
                                // 記事IDが無効な場合は、ローカルからの削除のみ実行
                                if (postId.length < 10 || !/^[a-zA-Z0-9_-]+$/.test(postId)) {
                                    console.warn('記事IDが無効な形式です。ローカルからの削除のみ実行します。');
                                } else {
                                    console.warn('microCMSからの削除に失敗しましたが、ローカルからの削除を実行します。');
                                }
                            } else if (response.status === 403) {
                                console.warn('権限エラーが発生しましたが、ローカルからの削除を実行します。');
                            } else if (response.status === 404) {
                                console.warn('記事が見つかりませんでしたが、ローカルからの削除を実行します。');
                            } else {
                                console.warn(`削除エラー (${response.status}) が発生しましたが、ローカルからの削除を実行します。`);
                            }
                        } else {
                            console.log('microCMSから削除成功:', postId);
                        }
                    } catch (fetchError) {
                        console.warn('microCMSへの接続エラーが発生しましたが、ローカルからの削除を実行します:', fetchError);
                    }
                }

                // すべてのローカルストレージから記事を削除
                console.log('ローカルストレージから記事を削除中:', postId);
                
                // 下書きから削除
                let drafts = JSON.parse(localStorage.getItem('blogDrafts') || '[]');
                const originalDraftsLength = drafts.length;
                drafts = drafts.filter(p => p.id !== postId);
                localStorage.setItem('blogDrafts', JSON.stringify(drafts));
                console.log(`下書きから削除: ${originalDraftsLength} → ${drafts.length}`);

                // 投稿済み記事からも削除
                let posts = JSON.parse(localStorage.getItem('blogPosts') || '[]');
                const originalPostsLength = posts.length;
                posts = posts.filter(p => p.id !== postId);
                localStorage.setItem('blogPosts', JSON.stringify(posts));
                console.log(`投稿済み記事から削除: ${originalPostsLength} → ${posts.length}`);

                // 削除された記事IDを記録
                let deletedPosts = JSON.parse(localStorage.getItem('deletedPostIds') || '[]');
                if (!deletedPosts.includes(postId)) {
                    deletedPosts.push(postId);
                    localStorage.setItem('deletedPostIds', JSON.stringify(deletedPosts));
                    console.log('削除された記事IDを記録:', postId);
                }

                // 投稿一覧を強制的に更新
                await loadPostsList();
                
                // 削除完了の確認
                console.log('削除処理完了。記事一覧を再読み込みしました。');

                if (showConfirm) {
                    alert('記事が削除されました。');
                }

            } catch (error) {
                console.error('削除エラー:', error);
                
                // エラー時もすべてのローカルストレージから記事を削除
                console.log('エラー発生時もローカルストレージから記事を削除中:', postId);
                
                // 下書きから削除
                let drafts = JSON.parse(localStorage.getItem('blogDrafts') || '[]');
                const originalDraftsLength = drafts.length;
                drafts = drafts.filter(p => p.id !== postId);
                localStorage.setItem('blogDrafts', JSON.stringify(drafts));
                console.log(`下書きから削除: ${originalDraftsLength} → ${drafts.length}`);

                // 投稿済み記事からも削除
                let posts = JSON.parse(localStorage.getItem('blogPosts') || '[]');
                const originalPostsLength = posts.length;
                posts = posts.filter(p => p.id !== postId);
                localStorage.setItem('blogPosts', JSON.stringify(posts));
                console.log(`投稿済み記事から削除: ${originalPostsLength} → ${posts.length}`);

                // 投稿一覧を更新
                loadPostsList();

                if (showConfirm) {
                    // より詳細なエラー情報を表示
                    let errorMessage = `microCMSからの削除に失敗しました。\n`;
                    errorMessage += `ローカルからは削除されました。\n\n`;
                    errorMessage += `エラー詳細: ${error.message}\n\n`;
                    
                    // 400エラーの場合は特別な対処方法を提示
                    if (error.message.includes('400')) {
                        errorMessage += `400エラーの対処方法:\n`;
                        errorMessage += `1. ブラウザの開発者ツール（F12）でコンソールを確認\n`;
                        errorMessage += `2. 記事IDの形式を確認\n`;
                        errorMessage += `3. ページを再読み込みして再試行\n`;
                        errorMessage += `4. 問題が続く場合は管理者に連絡`;
                    } else {
                        errorMessage += `対処方法:\n`;
                        errorMessage += `1. ページを再読み込みして再試行\n`;
                        errorMessage += `2. しばらく時間をおいてから再試行\n`;
                        errorMessage += `3. 問題が続く場合は管理者に連絡`;
                    }
                    
                    alert(errorMessage);
                }
            }
        }

        // デバッグ用：現在のストレージ状態を確認
        function debugStorage() {
            console.log('=== ストレージ状態デバッグ ===');
            const posts = JSON.parse(localStorage.getItem('blogPosts') || '[]');
            const drafts = JSON.parse(localStorage.getItem('blogDrafts') || '[]');
            const deletedIds = JSON.parse(localStorage.getItem('deletedPostIds') || '[]');
            
            console.log('投稿済み記事:', posts.length, '件');
            console.log('下書き:', drafts.length, '件');
            console.log('削除済みID:', deletedIds);
            
            if (posts.length > 0) {
                console.log('投稿済み記事のID:', posts.map(p => p.id));
            }
            if (drafts.length > 0) {
                console.log('下書きのID:', drafts.map(d => d.id));
            }
        }

        // サンプルデータの初期化
        function initializeSamplePosts() {
            const samplePosts = [
                {
                    id: 'sample_1',
                    title: 'デスクワークによる肩こりの原因と対策',
                    summary: '長時間のパソコン作業で起こる肩こりの原因と、簡単にできる予防・改善方法をご紹介します。',
                    content: 'デスクワークによる肩こりは現代人の悩みの一つです。武豊町のほぐし処HoguSeeSでは、多くのお客様が肩こりの改善を求めていらっしゃいます...',
                    category: 'health',
                    // tags: ['肩こり', 'デスクワーク', '武豊町', 'マッサージ'], // スキーマに存在しないため一時的に削除
                    status: 'published',
                    createdAt: new Date(Date.now() - 86400000).toISOString(),
                    author: 'ほぐし処スタッフ'
                },
                {
                    id: 'sample_2',
                    title: '冬の冷え性改善に効果的なマッサージ方法',
                    summary: '寒い季節に気になる手足の冷えを改善するセルフマッサージ方法をお教えします。',
                    content: '冬になると多くの方が悩まされる冷え性。血行を改善するマッサージで体を温めましょう...',
                    category: 'selfcare',
                    // tags: ['冷え性', '血行改善', 'セルフケア', '冬'], // スキーマに存在しないため一時的に削除
                    status: 'published',
                    createdAt: new Date(Date.now() - 172800000).toISOString(),
                    author: 'ほぐし処スタッフ'
                }
            ];

            localStorage.setItem('blogPosts', JSON.stringify(samplePosts));
        }

        // ページ読み込み時の処理
        window.addEventListener('load', function() {
            if (checkAuth()) {
                setupCharacterCount();
                loadKeywordSuggestions();
                
                // サンプルデータがない場合は初期化
                const existingPosts = localStorage.getItem('blogPosts');
                if (!existingPosts) {
                    initializeSamplePosts();
                }
                
                loadPostsList();
            }
        });
    </script>
</body>
</html>
